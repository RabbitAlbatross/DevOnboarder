# PATCHED v0.1.44 .github/workflows/codeql-scan.yml â€” CodeQL & on-chain check

name: "CodeQL Scan + On-Chain Verification"

on:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  DEVONBOARDER_ETHEREUM_RPC_URL:
    >-
      ${{ secrets.DEVONBOARDER_ETHEREUM_RPC_URL }}
  DEVONBOARDER_ANCHOR_CONTRACT_ADDRESS:
    >-
      ${{ secrets.DEVONBOARDER_ANCHOR_CONTRACT_ADDRESS }}
  DEVONBOARDER_REPO_ANCHOR_KEY:
    >-
      ${{ secrets.DEVONBOARDER_REPO_ANCHOR_KEY }}

jobs:
  codeql-scan:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Build CodeQL Scanner image
        run: docker-compose build codeql-scanner
      - name: Python CodeQL scan
        env:
          GITHUB_TOKEN: ${{ secrets.DEVONBOARDER_CODEQL_UPLOAD_TOKEN }}
        run: ./scripts/run-codeql-docker.sh python
      - name: JavaScript/TypeScript CodeQL scan
        env:
          GITHUB_TOKEN: ${{ secrets.DEVONBOARDER_CODEQL_UPLOAD_TOKEN }}
        run: ./scripts/run-codeql-docker.sh javascript
      - name: On-Chain Verification
        run: >-
          docker-compose run --rm codeql-scanner node
          /workspace/scripts/verify-on-chain.js
        env:
          DEVONBOARDER_ETHEREUM_RPC_URL: ${{ secrets.DEVONBOARDER_ETHEREUM_RPC_URL }}
          DEVONBOARDER_ANCHOR_CONTRACT_ADDRESS: ${{ secrets.DEVONBOARDER_ANCHOR_CONTRACT_ADDRESS }}
          DEVONBOARDER_REPO_ANCHOR_KEY: ${{ secrets.DEVONBOARDER_REPO_ANCHOR_KEY }}
